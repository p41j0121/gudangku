<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Histori Barang Keluar</title>
  <style>
    :root{
      --bg:#f5f7fb;
      --card:#ffffff;
      --accent:#185adb;
      --accent-2:#1abc9c;
      --muted:#6b7280;
      --soft:#eef3fb;
    }
    *{box-sizing:border-box}
    body{
      font-family: "Inter", "Segoe UI", Roboto, Arial, sans-serif;
      background:var(--bg);
      margin:0;
      padding:24px;
      color:#1f2937;
    }

    /* container */
    .container{
      max-width:1100px;
      margin:0 auto;
    }

    .back-button{
      position:fixed;
      top:18px;
      left:18px;
      background:var(--accent);
      color:#fff;
      border:none;
      padding:8px 12px;
      border-radius:8px;
      text-decoration:none;
      display:inline-flex;
      gap:8px;
      align-items:center;
      box-shadow:0 6px 18px rgba(24,90,219,0.12);
    }
    .back-button:hover{filter:brightness(.95)}

    header h1{
      margin:64px 0 8px;
      font-size:20px;
      letter-spacing:.2px;
    }
    header p{ margin:0 0 18px; color:var(--muted); font-size:14px }

    .card{
      background:var(--card);
      border-radius:12px;
      box-shadow:0 6px 24px rgba(31,41,55,0.06);
      padding:18px;
      overflow:auto;
    }

    #loading {
      display:none;
      text-align:center;
      color:var(--accent);
      font-weight:600;
      margin-bottom:12px;
    }

    table{
      width:100%;
      border-collapse:collapse;
      min-width:700px;
    }
    thead th{
      text-align:left;
      padding:12px 14px;
      background:linear-gradient(90deg,var(--accent),#2b7be6);
      color:#fff;
      font-weight:600;
      font-size:13px;
    }
    tbody td{
      padding:12px 14px;
      border-bottom:1px solid #eef2f7;
      vertical-align:middle;
      font-size:14px;
    }
    tbody tr:hover td{ background:var(--soft); }

    .btn{
      display:inline-flex;
      gap:8px;
      align-items:center;
      justify-content:center;
      border-radius:8px;
      padding:7px 12px;
      color:#fff;
      border:0;
      cursor:pointer;
      font-weight:600;
      font-size:13px;
    }
    .btn-edit{ background:var(--accent); }
    .btn-save{ background:var(--accent-2); display:none; }

    .btn:disabled{ opacity:.7; cursor:not-allowed; }

    .spinner {
      width:14px;
      height:14px;
      border-radius:50%;
      border:2px solid rgba(255,255,255,0.35);
      border-top-color: #fff;
      animation:spin .7s linear infinite;
      display:inline-block;
      vertical-align:middle;
    }
    @keyframes spin{ to{ transform:rotate(360deg) } }

    /* modal notif */
    .modal-backdrop{
      position:fixed; inset:0; background:rgba(10,11,13,0.45);
      display:none; align-items:center; justify-content:center; z-index:9999;
    }
    .modal{
      background:var(--card);
      border-radius:10px;
      width:420px;
      max-width:90%;
      padding:18px;
      box-shadow:0 12px 40px rgba(0,0,0,0.18);
    }
    .modal h3{ margin:0 0 8px; font-size:16px }
    .modal p{ margin:0 0 16px; color:var(--muted); }
    .modal .actions{ text-align:right }
    .modal .ok-btn{
      background:var(--accent);
      color:#fff;
      padding:8px 12px;
      border-radius:8px;
      border:0;
      font-weight:600;
      cursor:pointer;
    }
    .modal .ok-btn.err{ background:#e53e3e }
  </style>
</head>
<body>
  <a class="back-button" href="stok.html">⬅ Kembali</a>

  <div class="container">
    <header>
      <h1>Histori Barang Keluar</h1>
      <p>Riwayat keluar barang — edit langsung di tabel. Setelah klik Simpan, tunggu sampai notifikasi berhasil lalu klik OK untuk menyelesaikan perubahan.</p>
    </header>

    <div class="card">
      <div id="loading">⏳ Memuat data...</div>

      <table aria-describedby="histori">
        <thead>
          <tr>
            <th>Tanggal</th>
            <th>Tujuan</th>
            <th>Nama Barang</th>
            <th>Jumlah</th>
            <th>ID Kendaraan</th>
            <th>Aksi</th>
          </tr>
        </thead>
        <tbody id="histori-body"></tbody>
      </table>
    </div>
  </div>

  <!-- modal notifikasi -->
  <div class="modal-backdrop" id="modalBackdrop" role="dialog" aria-modal="true" aria-hidden="true">
    <div class="modal" id="modalBox">
      <h3 id="modalTitle">Sukses</h3>
      <p id="modalMessage">Perubahan berhasil disimpan.</p>
      <div class="actions">
        <button class="ok-btn" id="modalOk">OK</button>
      </div>
    </div>
  </div>

<script>
  const GAS_URL = "https://script.google.com/macros/s/AKfycby-WuPfGj-MkdOxJhpcOJ4guhpALeOzIncDOWbTnR1pZkCOOp-f30iEjC_7fbwdJYNXjA/exec";

  // ambil hanya tanggal (robust)
  function formatDateOnly(v){
    if(!v && v !== 0) return '';
    const s = String(v).trim();
    // cari YYYY-MM-DD
    let m = s.match(/\d{4}-\d{2}-\d{2}/);
    if(m) return m[0];
    // iso T
    if(s.includes('T')) return s.split('T')[0];
    // token sebelum spasi
    if(s.includes(' ')) return s.split(' ')[0];
    // dd/mm/yyyy
    m = s.match(/(\d{1,2})\/(\d{1,2})\/(\d{4})/);
    if(m){ const d = m[1].padStart(2,'0'), mo = m[2].padStart(2,'0'), y=m[3]; return `${y}-${mo}-${d}` }
    return s;
  }

  // modal helper -> returns Promise that resolves when user clicks OK
  function showModal(title, message, isError=false){
    return new Promise(resolve=>{
      const backdrop = document.getElementById('modalBackdrop');
      const modalTitle = document.getElementById('modalTitle');
      const modalMessage = document.getElementById('modalMessage');
      const ok = document.getElementById('modalOk');

      modalTitle.textContent = title || (isError? 'Error':'Sukses');
      modalMessage.textContent = message || '';
      ok.classList.toggle('err', !!isError);

      backdrop.style.display = 'flex';
      backdrop.setAttribute('aria-hidden','false');

      function done(){
        backdrop.style.display = 'none';
        backdrop.setAttribute('aria-hidden','true');
        ok.removeEventListener('click', done);
        resolve();
      }
      ok.addEventListener('click', done);
    });
  }

  async function fetchJson(url){
    const r = await fetch(url);
    if(!r.ok) throw new Error(`HTTP ${r.status}`);
    return r.json();
  }

  document.addEventListener('DOMContentLoaded', loadHistori);

  async function loadHistori(){
    const loading = document.getElementById('loading');
    loading.style.display = 'block';
    try{
      const data = await fetchJson(`${GAS_URL}?action=lihatBarangKeluar`);
      const tbody = document.getElementById('histori-body');
      tbody.innerHTML = '';
      data.forEach((row, index)=>{
        const tanggal = formatDateOnly(row.tanggal || row.Tanggal || row.tanggal_raw || '');
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td data-field="tanggal">${tanggal}</td>
          <td data-field="tujuan">${row.tujuan || ''}</td>
          <td data-field="nama">${row.nama || ''}</td>
          <td data-field="jumlah">${row.jumlah || ''}</td>
          <td data-field="id_kendaraan">${row.id_kendaraan || row.id_kendaraan || ''}</td>
          <td>
            <button class="btn btn-edit" data-index="${index}" onclick="enableEdit(this)">Edit</button>
            <button class="btn btn-save" data-index="${index}" onclick="saveEdit(this)">Simpan</button>
          </td>
        `;
        tbody.appendChild(tr);
      });
    }catch(err){
      console.error(err);
      alert('Gagal memuat histori. Cek console.');
    }finally{
      document.getElementById('loading').style.display = 'none';
    }
  }

  function enableEdit(btn){
    const tr = btn.closest('tr');
    tr.querySelectorAll('td[data-field]').forEach(td=>{
      td.contentEditable = true;
      td.style.background = '#fff8e6'; // visual cue
    });
    btn.style.display = 'none';
    tr.querySelector('.btn-save').style.display = 'inline-flex';
  }

  async function saveEdit(saveBtn){
    const tr = saveBtn.closest('tr');
    const editBtn = tr.querySelector('.btn-edit');

    // show spinner and disable
    const origHtml = saveBtn.innerHTML;
    saveBtn.innerHTML = `<span class="spinner"></span> Menyimpan...`;
    saveBtn.disabled = true;

    // ambil nilai
    const tanggalRaw = tr.querySelector("td[data-field='tanggal']").innerText.trim();
    const tanggal = formatDateOnly(tanggalRaw);
    const tujuan = tr.querySelector("td[data-field='tujuan']").innerText.trim();
    const nama = tr.querySelector("td[data-field='nama']").innerText.trim();
    const jumlah = tr.querySelector("td[data-field='jumlah']").innerText.trim();
    const id_kendaraan = tr.querySelector("td[data-field='id_kendaraan']").innerText.trim();

    // kirim request
    try{
      const url = `${GAS_URL}?action=editBarangKeluar&index=${encodeURIComponent(saveBtn.dataset.index)}`
                + `&tanggal=${encodeURIComponent(tanggal)}`
                + `&tujuan=${encodeURIComponent(tujuan)}`
                + `&nama=${encodeURIComponent(nama)}`
                + `&jumlah=${encodeURIComponent(jumlah)}`
                + `&id_kendaraan=${encodeURIComponent(id_kendaraan)}`;

      const resp = await fetch(url);
      const text = await resp.text();

      // tampilkan modal sukses sambil spinner masih jalan
      await showModal('Berhasil', text, false);

      // setelah user klik OK -> hentikan spinner & kembalikan tombol & keluar dari mode edit
      saveBtn.innerHTML = origHtml;
      saveBtn.disabled = false;
      saveBtn.style.display = 'none';
      editBtn.style.display = 'inline-flex';

      tr.querySelectorAll('td[data-field]').forEach(td=>{
        td.contentEditable = false;
        td.style.background = ''; // reset visual cue
      });

      // refresh tabel di background (bisa juga cuma update row, tapi reload lebih simple)
      loadHistori();

    }catch(err){
      console.error(err);
      // tampil modal error dan hentikan spinner hanya setelah user klik OK
      await showModal('Gagal', err.message || 'Terjadi kesalahan', true);
      saveBtn.innerHTML = origHtml;
      saveBtn.disabled = false;
    }
  }
</script>
</body>
</html>
